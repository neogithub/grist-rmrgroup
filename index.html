<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Property Dashboard</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; }
    .dashboard { display: flex; gap: 20px; flex-wrap: wrap; }
    .info-box { background: #f4f4f4; padding: 15px; border-radius: 5px; width: 200px; text-align: center; }
    .charts { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
    canvas { max-width: 500px; background: white; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
  </style>
</head>
<body>
  <h1>Property Dashboard</h1>
  <div class="dashboard">
    <div class="info-box"><h2>Total Properties</h2><p id="total-properties">-</p></div>
    <div class="info-box"><h2>Total Square Footage</h2><p id="total-square-footage">-</p></div>
    <div class="info-box"><h2>Total Buildings</h2><p id="total-buildings">-</p></div>
  </div>
  <div class="charts">
    <canvas id="stateChart"></canvas>
    <canvas id="propertyTypeChart"></canvas>
    <canvas id="ownershipChart"></canvas>
  </div>
  <script>
    let records = [];
    grist.ready();
    grist.onRecords(data => {
      records = data;
      updateDashboard(records);
    });
    function updateDashboard(records) {
      let totalProperties = records.length;
      let totalSquareFootage = records.reduce((sum, r) => sum + (r.Size || 0), 0);
      let totalBuildings = records.reduce((sum, r) => sum + (r.Building_Count || 0), 0);
      document.getElementById("total-properties").innerText = totalProperties;
      document.getElementById("total-square-footage").innerText = totalSquareFootage.toLocaleString();
      document.getElementById("total-buildings").innerText = totalBuildings;
      createCharts(records);
    }
    function createCharts(records) {
      const stateCounts = countBy(records, 'State');
      const propertyTypes = countBy(records, 'Property_Type');
      const owners = countBy(records, 'Owner');
      drawChart('stateChart', 'bar', stateCounts, 'Properties by State');
      drawChart('propertyTypeChart', 'pie', propertyTypes, 'Property Type Distribution');
      drawChart('ownershipChart', 'pie', owners, 'Ownership Breakdown');
    }
    function countBy(records, key) {
      return records.reduce((acc, r) => {
        let value = r[key] || 'Unknown';
        acc[value] = (acc[value] || 0) + 1;
        return acc;
      }, {});
    }
    function drawChart(id, type, data, title) {
      const ctx = document.getElementById(id).getContext('2d');
      new Chart(ctx, {
        type: type,
        data: {
          labels: Object.keys(data),
          datasets: [{
            data: Object.values(data),
            backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40']
          }]
        },
        options: { responsive: true, plugins: { title: { display: true, text: title } } }
      });
    }
  </script>
</body>
</html>
