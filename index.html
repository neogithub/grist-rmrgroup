<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Property Dashboard</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; }
    .dashboard { display: flex; gap: 20px; flex-wrap: wrap; }
    .info-box { background: #f4f4f4; padding: 15px; border-radius: 5px; width: 200px; text-align: center; }
    .charts { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
    canvas { max-width: 500px; background: white; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    .filters { margin-bottom: 15px; }
    select { padding: 8px; margin-right: 10px; }
  </style>
</head>
<body>
  <h1>Property Dashboard</h1>
  <div class="filters">
    <label for="stateFilter">State:</label>
    <select id="stateFilter"><option value="all">All States</option></select>
    <label for="propertyTypeFilter">Property Type:</label>
    <select id="propertyTypeFilter"><option value="all">All Property Types</option></select>
  </div>
  <div class="dashboard">
    <div class="info-box"><h2>Total Properties</h2><p id="total-properties">-</p></div>
    <div class="info-box"><h2>Total Square Footage</h2><p id="total-square-footage">-</p></div>
    <div class="info-box"><h2>Total Buildings</h2><p id="total-buildings">-</p></div>
  </div>
  <div class="charts">
    <canvas id="stateChart"></canvas>
    <canvas id="propertyTypeChart"></canvas>
    <canvas id="ownershipChart"></canvas>
  </div>
  <script>
    let records = [];
    let stateChart, propertyTypeChart, ownershipChart;

    grist.ready();
    grist.onRecords(data => {
      records = data.records;
      populateFilters(records);
      updateDashboard(records);
    });

    function populateFilters(records) {
      const states = [...new Set(records.map(r => r.State).filter(Boolean))].sort();
      const propertyTypes = [...new Set(records.map(r => r.Property_Type).filter(Boolean))].sort();
      
      populateSelect("stateFilter", states);
      populateSelect("propertyTypeFilter", propertyTypes);
    }

    function populateSelect(selectId, options) {
      const select = document.getElementById(selectId);
      select.innerHTML = '<option value="all">All</option>';
      options.forEach(option => {
        const opt = document.createElement("option");
        opt.value = option;
        opt.textContent = option;
        select.appendChild(opt);
      });
    }

    document.getElementById("stateFilter").addEventListener("change", () => updateDashboard(records));
    document.getElementById("propertyTypeFilter").addEventListener("change", () => updateDashboard(records));

    function updateDashboard(records) {
      let filteredRecords = records;
      const selectedState = document.getElementById("stateFilter").value;
      const selectedPropertyType = document.getElementById("propertyTypeFilter").value;
      
      if (selectedState !== "all") {
        filteredRecords = filteredRecords.filter(r => r.State === selectedState);
      }
      if (selectedPropertyType !== "all") {
        filteredRecords = filteredRecords.filter(r => r.Property_Type === selectedPropertyType);
      }

      let totalProperties = filteredRecords.length;
      let totalSquareFootage = filteredRecords.reduce((sum, r) => sum + (parseFloat(r.Size) || 0), 0);
      let totalBuildings = filteredRecords.reduce((sum, r) => sum + (parseInt(r.Building_Count) || 0), 0);
      document.getElementById("total-properties").innerText = totalProperties;
      document.getElementById("total-square-footage").innerText = totalSquareFootage.toLocaleString();
      document.getElementById("total-buildings").innerText = totalBuildings;
      createCharts(filteredRecords);
    }

    function createCharts(records) {
      const stateCounts = countBy(records, 'State');
      const propertyTypes = countBy(records, 'Property_Type');
      const owners = countBy(records, 'Owner');
      
      stateChart = updateChart('stateChart', 'bar', stateCounts, 'Properties by State', stateChart);
      propertyTypeChart = updateChart('propertyTypeChart', 'pie', propertyTypes, 'Property Type Distribution', propertyTypeChart);
      ownershipChart = updateChart('ownershipChart', 'pie', owners, 'Ownership Breakdown', ownershipChart);
    }

    function countBy(records, key) {
      return records.reduce((acc, r) => {
        let value = r[key] || 'Unknown';
        acc[value] = (acc[value] || 0) + 1;
        return acc;
      }, {});
    }

    function updateChart(id, type, data, title, chartRef) {
      const ctx = document.getElementById(id).getContext('2d');
      if (chartRef) chartRef.destroy();
      return new Chart(ctx, {
        type: type,
        data: {
          labels: Object.keys(data),
          datasets: [{
            data: Object.values(data),
            backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40']
          }]
        },
        options: { responsive: true, plugins: { title: { display: true, text: title } } }
      });
    }
  </script>
</body>
</html>
